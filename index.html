<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MCP Research Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        svg { width: 100%; height: 600px; background: #f0f0f0; }
        .node circle { fill: #69b3a2; stroke: #fff; stroke-width: 2px; transition: fill 0.3s; }
        .node.active circle { fill: #ff6b6b; animation: pulse 1s infinite; }
        .node text { font-size: 12px; fill: #333; }
        .link { stroke-width: 2px; stroke-dasharray: 5; }
        .link.connection { stroke: #ff6b6b; } /* Red for connections */
        .link.data { stroke: #3498db; } /* Blue for data */
        .link.status { stroke: #2ecc71; } /* Green for status */
        .tooltip { 
            position: absolute; 
            background: rgba(255, 255, 255, 0.9); 
            border: 1px solid #ccc; 
            padding: 5px; 
            font-size: 10px; 
            pointer-events: none; 
            max-width: 200px; 
            white-space: pre-wrap; 
        }
        #log { 
            position: absolute; 
            bottom: 10px; 
            left: 10px; 
            right: 10px; 
            height: 150px; 
            overflow-y: auto; 
            background: #fff; 
            border: 1px solid #ccc; 
            padding: 10px; 
            font-size: 12px; 
        }
        @keyframes pulse { 0% { r: 10; } 50% { r: 12; } 100% { r: 10; } }
    </style>
</head>
<body>
    <svg></svg>
    <div id="log"></div>
    <script>
        const svg = d3.select("svg"),
              width = window.innerWidth,
              height = 600;

        const nodes = [
            { id: "Research Assistant", x: width / 2, y: height / 2 },
            { id: "Brave", x: width / 4, y: height / 4 },
            { id: "Puppeteer", x: 3 * width / 4, y: height / 4 },
            { id: "GitHub", x: width / 4, y: 3 * height / 4 },
            { id: "Notion", x: 3 * width / 4, y: 3 * height / 4 },
            { id: "Claude", x: width / 2, y: height / 3 },
            { id: "ChromaDB", x: width / 2, y: 3 * height / 4 }
        ];
        let links = [];

        const simulation = d3.forceSimulation(nodes)
            .force("charge", d3.forceManyBody().strength(-150))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("link", d3.forceLink(links).distance(100))
            .force("collision", d3.forceCollide(50));

        const link = svg.append("g").selectAll(".link");
        const node = svg.append("g")
            .selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node");

        node.append("circle").attr("r", 10);
        node.append("text").text(d => d.id).attr("dx", 12).attr("dy", ".35em");

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        const log = document.getElementById("log");
        function addLog(message) {
            const p = document.createElement("p");
            p.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }

        function updateLinks() {
            link.data(links).exit().remove();
            link.data(links).enter().append("line")
                .attr("class", d => `link ${d.type}`);
            simulation.force("link").links(links);
            simulation.alpha(1).restart();
        }

        const ws = new WebSocket("ws://localhost:8765");
        ws.onopen = () => addLog("Connected to WebSocket server");
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            addLog(`${data.type}: ${data.message}`);

            const sourceNode = data.source ? nodes.find(n => n.id === data.source) : null;
            const targetNode = data.target ? nodes.find(n => n.id === data.target) : null;

            // Handle all event types with links
            if (sourceNode && targetNode) {
                links.push({ source: sourceNode, target: targetNode, type: data.type });
                updateLinks();
                d3.select(sourceNode._groups[0][0]).classed("active", true);
                d3.select(targetNode._groups[0][0]).classed("active", true);
                setTimeout(() => {
                    links = links.filter(l => l.source !== sourceNode || l.target !== targetNode);
                    updateLinks();
                    d3.select(sourceNode._groups[0][0]).classed("active", false);
                    d3.select(targetNode._groups[0][0]).classed("active", false);
                }, 3000);
            }

            // Show tooltips
            if (data.type === "tools" && targetNode) {
                tooltip.transition().duration(200).style("opacity", 0.9)
                    .html(`Tools for ${data.target}:\n${data.tools.join('\n')}`)
                    .style("left", (targetNode.x + 20) + "px")
                    .style("top", (targetNode.y - 30) + "px");
                setTimeout(() => tooltip.transition().duration(500).style("opacity", 0), 4000);
            } else if (data.message.includes("Claude is calling") && sourceNode && targetNode) {
                tooltip.transition().duration(200).style("opacity", 0.9)
                    .html(`Prompt: ${data.message}`)
                    .style("left", (sourceNode.x + 20) + "px")
                    .style("top", (sourceNode.y - 30) + "px");
                setTimeout(() => tooltip.transition().duration(500).style("opacity", 0), 4000);
            }
        };
        ws.onerror = (error) => addLog(`WebSocket error: ${error}`);
        ws.onclose = () => addLog("WebSocket connection closed");
    </script>
</body>
</html>